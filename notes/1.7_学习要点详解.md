# 第1.7章：投资组合优化 - 超详细解释

## 📊 第一部分：投资组合构建（Portfolio Construction）

### 什么是投资组合？

**生活化理解：**
想象你有100万元，你不想把所有钱都投在一只股票上（风险太大），而是想分散投资：
- 40% 投SPY（市场指数）
- 40% 投XOM（石油公司）
- 10% 投GOOG（科技公司）
- 10% 投GLD（黄金）

这就是一个**投资组合**（Portfolio）

### 为什么要构建投资组合？

**问题：** 为什么不能把所有钱投在一只股票上？
- **风险太大**：如果这只股票暴跌，你会损失惨重
- **机会有限**：只投一只股票，错过了其他好机会

**投资组合的好处：**
1. **分散风险**：一只股票跌，其他可能涨，降低总风险
2. **稳定收益**：不同股票互相平衡，收益更稳定
3. **灵活调整**：可以根据市场变化调整比例

---

## 🔢 第二部分：价格归一化（Normalization）

### 什么是归一化？

**生活化理解：**
不同股票的价格差异很大：
- SPY：100元/股
- GOOG：500元/股
- GLD：80元/股

**问题：** 如何公平比较它们的涨跌？

**解决方案：归一化**
把所有股票的价格都"调整"到同一个起点（比如都从1.0开始）

### 归一化公式

```python
normed = prices / prices[0]
```

**拆解：**
- `prices[0]` = 第一天的价格（起始价格）
- `prices / prices[0]` = 每天价格 ÷ 起始价格

**例子：**
```
日期        SPY价格   归一化后    GOOG价格   归一化后
1月1日      100       1.0        500        1.0
1月2日      105       1.05       510        1.02
1月3日      98        0.98       495        0.99
```

**归一化的好处：**
- 所有股票都从1.0开始，方便比较
- 可以看到相对涨跌幅度
- 便于计算投资组合价值

---

## 💰 第三部分：分配资金（Allocation）

### 什么是分配（Allocation）？

**生活化理解：**
你有100万元，要按比例分配：
- SPY：40% = 40万元
- XOM：40% = 40万元
- GOOG：10% = 10万元
- GLD：10% = 10万元

**分配列表（allocs）：**
```python
allocs = [0.4, 0.4, 0.1, 0.1]  # 对应 [SPY, XOM, GOOG, GLD]
```

**注意：** 所有分配加起来必须等于1.0（100%）

### 应用分配

```python
alloced = normed * allocs
```

**拆解：**
- `normed` = 归一化后的价格（每只股票都是1.0开始）
- `allocs` = 分配比例 [0.4, 0.4, 0.1, 0.1]
- `normed * allocs` = 每只股票的"权重价格"

**例子：**
```
日期       SPY归一化   SPY分配后    XOM归一化   XOM分配后
1月1日     1.0        0.4         1.0        0.4
1月2日     1.05       0.42        1.02       0.408
```

**含义：**
- SPY分配后 = 1.0 × 0.4 = 0.4（表示SPY在组合中占40%）
- 如果SPY涨到1.05，分配后 = 1.05 × 0.4 = 0.42（SPY部分涨了5%）

---

## 📈 第四部分：计算持仓价值（Position Values）

### 什么是持仓价值？

**生活化理解：**
你投了40万元在SPY上，如果SPY涨了5%，你的SPY持仓就值42万元

**公式：**
```python
pos_vals = alloced * start_val
```

**拆解：**
- `alloced` = 分配后的权重价格
- `start_val` = 起始资金（比如100万元）
- `pos_vals` = 每只股票的实际持仓价值

**例子：**
```
日期       SPY分配后   SPY持仓价值    XOM分配后   XOM持仓价值
1月1日     0.4        40万          0.4        40万
1月2日     0.42       42万          0.408       40.8万
```

**计算过程：**
- SPY持仓价值 = 0.4 × 100万 = 40万
- 如果SPY涨到0.42，持仓价值 = 0.42 × 100万 = 42万

---

## 💼 第五部分：投资组合总价值（Portfolio Value）

### 什么是投资组合总价值？

**生活化理解：**
你的总资产 = SPY持仓 + XOM持仓 + GOOG持仓 + GLD持仓

**公式：**
```python
port_val = pos_vals.sum(axis=1)
```

**拆解：**
- `pos_vals` = 每只股票的持仓价值（DataFrame）
- `.sum(axis=1)` = 按行求和（把每只股票的价值加起来）
- `port_val` = 每天的投资组合总价值

**例子：**
```
日期       SPY持仓    XOM持仓    GOOG持仓   GLD持仓   组合总价值
1月1日     40万       40万       10万       10万      100万
1月2日     42万       40.8万     10.2万     10.1万    103.1万
1月3日     39.2万     39.6万     9.9万      9.95万    98.65万
```

**含义：**
- 1月1日：总价值 = 100万（起始资金）
- 1月2日：总价值 = 103.1万（赚了3.1万，3.1%）
- 1月3日：总价值 = 98.65万（亏了1.35万，-1.35%）

---

## 📊 第六部分：投资组合日收益率（Portfolio Daily Returns）

### 什么是投资组合日收益率？

**生活化理解：**
和单只股票的日收益率一样，但这是整个投资组合的收益率

**公式：**
```python
daily_rets[1:] = (port_val[1:] / port_val[:-1].values) - 1
```

**拆解：**
- `port_val[1:]` = 今天及以后的组合价值
- `port_val[:-1]` = 昨天及以前的组合价值
- `port_val[1:] / port_val[:-1]` = 今天价值 ÷ 昨天价值
- `- 1` = 减去1，得到增长率

**例子：**
```
日期        组合价值    计算过程              日收益率
1月1日      100万      (第一行，设为0)       0%
1月2日      103.1万    (103.1/100) - 1      3.1%
1月3日      98.65万    (98.65/103.1) - 1    -4.3%
```

**注意：**
- 第一天的日收益率设为0（没有前一天）
- 日收益率可以是正数（赚钱）或负数（亏钱）

---

## 📈 第七部分：累计收益率（Cumulative Return）

### 什么是累计收益率？

**生活化理解：**
从开始投资到现在，总共赚了（或亏了）多少百分比

**公式：**
```python
cum_ret = (port_val[-1] / port_val[0]) - 1
```

**拆解：**
- `port_val[-1]` = 最后一天的投资组合价值
- `port_val[0]` = 第一天的投资组合价值（起始资金）
- `port_val[-1] / port_val[0]` = 最终价值 ÷ 起始价值
- `- 1` = 减去1，得到总收益率

**例子：**
```
起始价值：100万
最终价值：150万
累计收益率 = (150/100) - 1 = 0.5 = 50%
```

**含义：**
- **累计收益率 > 0**：总体赚钱
- **累计收益率 < 0**：总体亏钱
- **累计收益率 = 0**：不赚不亏

**实际应用：**
- 如果累计收益率 = 0.3（30%），说明3年赚了30%
- 如果累计收益率 = -0.2（-20%），说明亏了20%

---

## 📊 第八部分：平均日收益率（Average Daily Return）

### 什么是平均日收益率？

**生活化理解：**
把所有日收益率加起来，除以天数，得到平均每天赚（或亏）多少

**公式：**
```python
avg_daily_ret = daily_rets.mean()
```

**例子：**
```
100天的日收益率：+2%, -1%, +0.5%, -0.3%, +1.2%, ...
平均日收益率 = 0.05% = 平均每天赚0.05%
```

**含义：**
- **平均日收益率 > 0**：平均每天赚钱
- **平均日收益率 < 0**：平均每天亏钱
- **平均日收益率 = 0**：平均不赚不亏

**实际应用：**
- 如果平均日收益率 = 0.001（0.1%），一年约252个交易日
- 年化收益率 ≈ 0.001 × 252 = 25.2%（复利计算会更准确）

---

## 📉 第九部分：日收益率标准差（Standard Deviation of Daily Returns）

### 什么是标准差？

**生活化理解：**
标准差衡量"日收益率有多分散"
- **标准差小** = 收益率都集中在均值附近 = **风险低，稳定**
- **标准差大** = 收益率分散，有时大涨有时大跌 = **风险高，不稳定**

**公式：**
```python
std_daily_ret = daily_rets.std()
```

**例子对比：**
```
组合A（稳定）：
日收益率总是在 0% ± 1% 之间
标准差 = 0.5%  → 风险低

组合B（波动大）：
日收益率在 -5% 到 +5% 之间乱跳
标准差 = 3%    → 风险高
```

**实际意义：**
- 标准差是衡量**风险**的重要指标
- 标准差越大，投资组合越不稳定
- 保守投资者应该选择标准差小的组合

---

## 🎯 第十部分：夏普比率（Sharpe Ratio）- 最重要！

### 什么是夏普比率？

**生活化理解：**
夏普比率衡量"每承担一单位风险，能获得多少超额收益"

**问题：**
- 组合A：年收益20%，但波动很大（风险高）
- 组合B：年收益15%，但很稳定（风险低）

哪个更好？**夏普比率帮你判断！**

### 夏普比率公式

```python
SR = sqrt(k) * mean(daily_rets - daily_rf) / std(daily_rets)
```

**拆解：**
- `daily_rets` = 日收益率
- `daily_rf` = 日无风险利率（通常设为0）
- `mean(daily_rets - daily_rf)` = 平均超额收益
- `std(daily_rets)` = 日收益率标准差（风险）
- `sqrt(k)` = 年化因子（k=252，一年约252个交易日）

**简化理解：**
```
夏普比率 = 年化超额收益 / 年化风险
```

### 夏普比率的含义

| 夏普比率 | 含义 | 评价 |
|---------|------|------|
| **SR > 1** | 很好 | 收益远高于风险 |
| **SR = 1** | 好 | 收益与风险平衡 |
| **SR = 0.5** | 一般 | 收益略高于风险 |
| **SR < 0** | 差 | 收益不如无风险投资 |

**实际例子：**
```
组合A：
- 年化收益：20%
- 年化风险（标准差）：15%
- 夏普比率 = 20% / 15% = 1.33  → 很好！

组合B：
- 年化收益：25%
- 年化风险（标准差）：30%
- 夏普比率 = 25% / 30% = 0.83  → 一般

结论：组合A更好（虽然收益低，但风险更小）
```

### 为什么夏普比率重要？

**核心思想：**
- **不是收益越高越好**，而是**风险调整后的收益**越高越好
- 夏普比率帮你找到"性价比"最高的投资组合

**实际应用：**
- 比较不同投资组合
- 优化投资组合（最大化夏普比率）
- 评估基金经理的表现

---

## 🔧 第十一部分：投资组合优化（Portfolio Optimization）

### 什么是投资组合优化？

**生活化理解：**
你有4只股票（SPY, XOM, GOOG, GLD），如何分配资金，让投资组合的**夏普比率最大**？

**问题：**
- 应该40% SPY + 40% XOM + 10% GOOG + 10% GLD？
- 还是25% + 25% + 25% + 25%？
- 还是其他比例？

**优化目标：**
找到最优的分配比例，使得：
- **夏普比率最大**（风险调整后的收益最高）
- **所有分配加起来 = 1.0**（100%）
- **每个分配 ≥ 0**（不能做空，至少在这个练习中）

### 优化方法

**步骤：**
1. 定义目标函数：最大化夏普比率（或最小化负夏普比率）
2. 定义约束条件：
   - 所有分配加起来 = 1.0
   - 每个分配在 0 到 1 之间
3. 使用优化算法（如scipy.optimize.minimize）求解

**例子：**
```
初始分配：[0.4, 0.4, 0.1, 0.1]
夏普比率：1.2

优化后分配：[0.3, 0.2, 0.3, 0.2]
夏普比率：1.5  → 更好！
```

---

## 🎯 实际应用场景

### 场景1：评估投资组合表现

**步骤：**
1. 构建投资组合（选择股票和分配）
2. 计算投资组合价值
3. 计算累计收益率
4. 计算夏普比率

**决策：**
- 累计收益率 > 0 且夏普比率 > 1 → **好组合！**
- 累计收益率 < 0 或夏普比率 < 0 → **需要调整**

### 场景2：比较不同投资组合

**方法：**
1. 构建多个投资组合（不同分配）
2. 计算每个组合的夏普比率
3. 选择夏普比率最高的组合

**例子：**
```
组合A：40% SPY + 40% XOM + 10% GOOG + 10% GLD
夏普比率：1.2

组合B：25% SPY + 25% XOM + 25% GOOG + 25% GLD
夏普比率：1.35  → 更好！

组合C：100% SPY
夏普比率：0.8  → 最差

结论：选择组合B
```

### 场景3：优化投资组合

**方法：**
1. 使用优化算法找到最优分配
2. 比较优化前后的表现
3. 根据结果调整投资策略

**注意：**
- 优化基于历史数据，未来可能不同
- 需要考虑交易成本、流动性等因素
- 定期重新优化（市场在变化）

---

## 📝 快速记忆口诀

1. **归一化** = 价格 ÷ 起始价格，所有股票从1.0开始
2. **分配** = 每只股票的投资比例，总和必须=1.0
3. **持仓价值** = 归一化价格 × 分配 × 起始资金
4. **组合价值** = 所有持仓价值相加
5. **日收益率** = (今天/昨天) - 1
6. **累计收益率** = (最终价值/起始价值) - 1
7. **平均日收益率** = 所有日收益率的平均值
8. **标准差** = 衡量风险，越大越危险
9. **夏普比率** = 年化超额收益 / 年化风险，越大越好
10. **优化** = 找到夏普比率最大的分配

---

## 🔍 考试/作业常见问题

### Q1: 为什么要归一化价格？
**A:** 
- 不同股票价格差异大，无法直接比较
- 归一化后所有股票从1.0开始，方便计算组合价值
- 可以看到相对涨跌幅度

### Q2: 分配（allocs）必须满足什么条件？
**A:**
- 所有分配加起来必须等于1.0（100%）
- 每个分配通常在0到1之间（不能做空）
- 分配顺序必须与股票顺序对应

### Q3: 如何计算投资组合总价值？
**A:** 
- 先归一化价格
- 应用分配得到权重价格
- 乘以起始资金得到每只股票的持仓价值
- 把所有持仓价值相加

### Q4: 累计收益率和平均日收益率有什么区别？
**A:**
- **累计收益率**：从开始到现在的总收益率（一次性）
- **平均日收益率**：平均每天赚多少（每天）

**关系：**
- 如果平均日收益率 = r，n天后累计收益率 ≈ r × n（简单计算）
- 实际应该用复利：(1 + r)^n - 1

### Q5: 夏普比率 = 1.5 意味着什么？
**A:** 
- 年化超额收益是年化风险的1.5倍
- 这是很好的表现（SR > 1）
- 说明风险调整后的收益很高

### Q6: 如何优化投资组合？
**A:**
1. 定义目标：最大化夏普比率
2. 定义约束：分配总和=1.0，每个分配≥0
3. 使用优化算法求解
4. 验证结果（检查是否满足约束）

### Q7: 优化后的组合一定比初始组合好吗？
**A:** 
- **理论上**：是的，因为优化目标是最大化夏普比率
- **实际上**：
  - 优化基于历史数据，未来可能不同
  - 需要考虑交易成本
  - 可能需要定期重新优化

---

## 💡 总结

**核心思想：**
1. **归一化**让不同股票可以公平比较
2. **分配**决定每只股票的投资比例
3. **组合价值**反映整体投资表现
4. **累计收益率**衡量总体收益
5. **平均日收益率**衡量日常表现
6. **标准差**衡量风险大小
7. **夏普比率**是最重要的指标，衡量风险调整后的收益
8. **优化**帮你找到最佳投资组合

**实际应用：**
- 构建和评估投资组合
- 比较不同投资策略
- 优化投资分配
- 评估投资表现

**记住：** 在AI时代，你不需要死磕代码，但需要理解这些概念，这样才能：
- 看懂分析结果
- 做出正确决策
- 在考试/作业中回答概念性问题
- 在实际投资中应用这些知识

---

## 🔗 与1.6章的联系

**1.6章学的是：**
- 单只股票的日收益率
- 直方图和统计指标
- 股票之间的相关性（Beta, Alpha）

**1.7章学的是：**
- 多只股票组成的投资组合
- 组合的整体表现
- 如何优化组合分配

**关系：**
- 1.6是基础（理解单只股票）
- 1.7是应用（构建投资组合）
- 两者结合，才能做好投资分析
